var blurbGallery={init:function(e,t){var n=this;n.config=$.extend({},n.defaults,e);n.elem=t;n.$elem=$(t);$.when(n.load()).then(function(){n.render.call(n);n.events()},function(){alert("Error: Gallery load failed!")});return n},defaults:{ajax:{cache:false,dataType:"json",dataUrl:"json/jquery.blurbGallery.json"},callback:function(){},cssSelectors:{activePage:"bg-active-page",activeThumb:"bg-active-thumb",category:"bg-category",description:"bg-description",enlarge:"bg-enlarge",gallery:"bg-gallery",img:"bg-img",imgCtn:"bg-img-ctn",info:"bg-info",loading:"bg-loading",loadingImg:"bg-loading-img",nextLink:"bg-next-link",pageLink:"bg-page-link",pages:"bg-page-navigation",previousLink:"bg-previous-link",selectMenu:"bg-select-menu",selectNav:"bg-select-nav",thumbs:"bg-thumbs",title:"bg-title",wrapper:"bg-wrapper"},html5:true,loading:"img/bg-loading.gif",pages:{per:3,show:true},selected:{cat:false,item:false},speed:300},load:function(){var e=this,t=$.Deferred();$.ajax({cache:e.config.ajax.cache,dataType:e.config.ajax.dataType,url:e.config.ajax.dataUrl}).then(function(n){e.data=n;e.selected=e.findSelected(true);t.resolve()},function(){t.reject()});return t.promise()},events:function(){var e=this;e.$elem.on("click","."+e.config.cssSelectors.selectNav+" a",function(t){e.changeCategory.call(e,$(this).html());t.preventDefault()});e.$elem.on("click","."+e.config.cssSelectors.thumbs+" a",function(t){e.changeItem.call(e,$(this));t.preventDefault()});e.$elem.on("click","."+e.config.cssSelectors.previousLink,function(t){e.changePage.call(e,$(this),"previous");t.preventDefault()});e.$elem.on("click","."+e.config.cssSelectors.pageLink,function(t){e.changePage.call(e,$(this));t.preventDefault()});e.$elem.on("click","."+e.config.cssSelectors.nextLink,function(t){e.changePage.call(e,$(this),"next");t.preventDefault()})},changeCategory:function(e){var t=this,e=t.utils.formatText(e),n,r;$("."+t.config.cssSelectors.imgCtn).hide();$("."+t.config.cssSelectors.info).hide();if(t.config.loading)$("."+t.config.cssSelectors.loading).show();t.config.selected.cat=e;t.selected=t.findSelected();t.renderTitle($("."+t.config.cssSelectors.title));t.renderCategory($("."+t.config.cssSelectors.category));t.renderDescription($("."+t.config.cssSelectors.description));r=t.renderImage($("."+t.config.cssSelectors.img));n=t.renderThumbs($("."+t.config.cssSelectors.thumbs));$.when(t.utils.preload(r),t.utils.preload(r)).then(function(){if(t.config.loading)$("."+t.config.cssSelectors.loading).hide();$("."+t.config.cssSelectors.imgCtn).fadeIn(t.config.speed);$("."+t.config.cssSelectors.info).fadeIn(t.config.speed);t.config.callback()});t.pages={ctn:$("."+t.config.cssSelectors.pages),current:0,items:0,total:0,per:t.config.pages.per};t.renderPages($("."+t.config.cssSelectors.pages))},changeItem:function(e){var t=this,n=$("."+t.config.cssSelectors.loadingImg),r,i;i=$("."+t.config.cssSelectors.thumbs).find("a");i.removeClass(t.config.cssSelectors.activeThumb);e.addClass(t.config.cssSelectors.activeThumb);r=e.attr("href");t.findItem(r);t.renderTitle($("."+t.config.cssSelectors.title));t.renderDescription($("."+t.config.cssSelectors.description));src=t.renderImage($("."+t.config.cssSelectors.img));if(t.config.loading)n.show();$.when(t.utils.preload(src)).then(function(){if(t.config.loading)n.hide();t.config.callback()})},changePage:function(e,t){var n=this,r,i,s,o,u;if(t==="previous"){if(n.pages.current>0){r=(n.pages.current-1)*n.pages.per;i=r+n.pages.per;n.pages.current=parseInt(n.pages.current-1);s=n.pages.current;$("."+n.config.cssSelectors.pages).children().removeClass(n.config.cssSelectors.activePage);$("."+n.config.cssSelectors.pageLink).eq(s).addClass(n.config.cssSelectors.activePage)}}else if(t==="next"){if(n.pages.current+1<n.pages.total){r=(n.pages.current+1)*n.pages.per;i=r+n.pages.per;n.pages.current=parseInt(n.pages.current+1);s=n.pages.current;$("."+n.config.cssSelectors.pages).children().removeClass(n.config.cssSelectors.activePage);$("."+n.config.cssSelectors.pageLink).eq(s).addClass(n.config.cssSelectors.activePage)}}else{s=e.attr("id");n.pages.current=parseInt(s);r=n.pages.current*n.pages.per;i=r+n.pages.per;$("."+n.config.cssSelectors.pages).children().removeClass(n.config.cssSelectors.activePage);$("."+n.config.cssSelectors.pageLink).eq(s).addClass(n.config.cssSelectors.activePage)}n.sortThumbs(r,i);o=$("."+n.config.cssSelectors.previousLink);u=$("."+n.config.cssSelectors.nextLink);n.pages.current===0?o.hide():o.show();n.pages.current===n.pages.total-1?u.hide():u.css("display","inline-block")},render:function(){var e=this,t;if(e.config.html5){t=$("<section/>")}else{t=$("<div/>")}t.attr({"class":e.config.cssSelectors.wrapper});e.$elem.append(t);var n=function(){var n,r,i=e.data.blurbGallery,s,o,u;if(e.config.html5){n=$("<section/>");r=$("<nav/>")}else{n=$("<div/>");r=$("<div/>")}n.attr({"class":e.config.cssSelectors.selectMenu});r.attr({"class":e.config.cssSelectors.selectNav});for(o=0,u=i.length;o<u;++o){s=$("<a/>",{alt:i[o].id,href:"#",html:i[o].id,title:i[o].id});r.append(s)}n.append(r);t.append(n)};var r=function(){var n,r,i=$.Deferred();var s=function(){var t,r,i,s,o,u,a,f=$.Deferred();if(e.config.html5){t=$("<article/>");r=$("<section/>");i=$("<section/>")}else{t=$("<div/>");r=$("<div/>");i=$("<div/>")}if(e.config.loading){if(e.config.html5){s=$("<section/>")}else{s=$("<div/>")}s.attr({alt:"Loading...","class":e.config.cssSelectors.loadingImg,title:"Loading..."}).html('<img src="'+e.config.loading+'" />');r.append(s)}t.attr({"class":e.config.cssSelectors.img});r.attr({"class":e.config.cssSelectors.imgCtn});i.attr({"class":e.config.cssSelectors.enlarge}).html("Click image to enlarge");u=e.renderImage(t);$.when(e.utils.preload(u)).done(function(){f.resolve()});r.append(t,i);n.append(r);return f.promise()};var o=function(){var t,r,i,s,o=$.Deferred();var u=function(){var n,r;if(e.config.html5){n=$("<article/>")}else{n=$("<div/>")}n.attr({"class":e.config.cssSelectors.thumbs});r=e.renderThumbs(n);$.when(e.utils.preload(r)).done(function(){o.resolve()});t.append(n)};var a=function(){var n;if(e.config.html5){n=$("<section/>")}else{n=$("<div/>")}n.attr({"class":e.config.cssSelectors.pages});e.pages={ctn:n,current:0,items:0,pages:0,per:e.config.pages.per};e.renderPages(n);t.append(n)};if(e.config.html5){t=$("<section/>");r=$("<section/>");i=$("<section/>");s=$("<section/>")}else{t=$("<div/>");r=$("<div/>");i=$("<div/>");s=$("<div/>")}t.attr({"class":e.config.cssSelectors.info});e.renderTitle(r);e.renderCategory(i);e.renderDescription(s);n.append(t);t.append(r);t.append(i);t.append(s);u();if(e.config.pages.show)a();return o.promise()};if(e.config.html5){n=$("<section/>")}else{n=$("<div/>")}n.attr({"class":e.config.cssSelectors.gallery});t.append(n);if(e.config.loading){if(e.config.html5){r=$("<section/>")}else{r=$("<div/>")}r.attr({alt:"Loading...","class":e.config.cssSelectors.loading,title:"Loading..."}).html('<img src="'+e.config.loading+'" />');n.append(r)}$.when(s(),o()).then(function(){i.resolve()},function(){alert("Error: Gallery load failed!")});return i.promise()};$.when(n(),r()).then(function(){t.fadeIn(e.config.speed);e.config.callback()},function(){alert("Error: Failed to load gallery!")})},renderTitle:function(e){var t=this;e.attr({alt:t.selected.item.title,"class":t.config.cssSelectors.title,title:t.selected.item.title}).html(t.selected.item.title)},renderCategory:function(e){var t=this;e.attr({alt:t.selected.cat.id,"class":t.config.cssSelectors.category,title:t.selected.cat.id}).html(t.selected.cat.id)},renderDescription:function(e){var t=this;e.attr({alt:t.selected.item.info,"class":t.config.cssSelectors.description,title:t.selected.item.info}).html(t.selected.item.info)},renderImage:function(e){var t=this,n,r,i;e.empty();n=$("<a/>",{href:"img/full/"+t.selected.item.img}).appendTo(e);i="img/"+t.selected.item.img;r=$("<img/>",{src:i}).appendTo(n);return i},renderThumbs:function(e){var t=this,n=[],r,i,s;e.empty();for(s in t.selected.cat.item){r=$("<a/>").attr({href:t.selected.cat.item[s].img});if(t.selected.item.img===t.selected.cat.item[s].img){r.addClass(t.config.cssSelectors.activeThumb)}i=$("<img/>").attr({src:"img/thumbs/"+t.selected.cat.item[s].img});r.append(i).appendTo(e);n.push("img/thumbs/"+t.selected.cat.item[s].img)}return n},renderPages:function(e){var t=this;e.empty();t.pages.items=t.selected.cat.item.length;t.pages.total=Math.ceil(t.pages.items/t.pages.per);if(t.pages.items>t.pages.per){var n,r,i,s;if(t.config.html5){n=$("<section/>");r=$("<section/>")}else{n=$("<div/>");r=$("<div/>")}n.attr({alt:"Previous","class":t.config.cssSelectors.previousLink,title:"Previous"}).html("<< Previous");r.attr({alt:"next","class":t.config.cssSelectors.nextLink,title:"next"}).html("Next >>");t.pages.ctn.append(n);for(s=0;t.pages.total>s;++s){if(t.config.html5){i=$("<section/>",{alt:"Page "+(s+1),"class":t.config.cssSelectors.pageLink,html:s+1,id:s,title:"Page "+(s+1)})}else{i=$("<div/>",{alt:"Page "+(s+1),"class":t.config.cssSelectors.pageLink,html:s+1,id:s,title:"Page "+(s+1)})}if(s===0)i.addClass(t.config.cssSelectors.activePage);t.pages.ctn.append(i)}t.pages.ctn.append(r);t.pages.current===0?n.hide():n.show();t.pages.current===t.pages.total-1?r.hide():r.css("display","inline-block");t.sortThumbs()}},findSelected:function(e){var t=this,n,r;(function(){var r=t.data.blurbGallery,i,s,o,u=$("#bg-selected-cat").attr("value");if(u&&e){for(s=0,o=r.length;s<o;++s){i=t.utils.formatText(r[s].id);if(i===u){n=r[s]}}}else if(t.config.selected.cat){for(s=0,o=r.length;s<o;++s){if(t.utils.formatText(r[s].id)===t.utils.formatText(t.config.selected.cat)){n=r[s]}}}if(!n)n=r[0]})();(function(){var e;if(t.config.selected.item){for(e in n.item){if(t.utils.formatText(n.item[e].id)===t.utils.formatText(t.config.selected.item)){n=n.item[e]}}}if(!r)r=n.item[0]})();return{cat:n,item:r}},findItem:function(e){var t=this,n=t.selected.cat,r;for(r in n.item){if(n.item[r].img===e){t.selected.item=n.item[r]}}},sortThumbs:function(e,t){var n=this,r,e,t,i;if(!e)e=n.pages.current*n.pages.per;if(!t)t=e+n.pages.per;r=$(".bg-thumbs a");r.hide();r.slice(e,t).show()},utils:{formatText:function(e){e=e.toLowerCase();e=e.replace(/[^A-Za-z0-9]/g,"_");return e},preload:function(e){var t=$.Deferred(),n=[],r,i,s;if(!$.isArray(e)){e=[e]}i=e.length;for(var o=0;o<i;o++){s=$.Deferred();r=$("<img />");r.load(s.resolve);r.error(s.resolve);n.push(s);r.get(0).src=e[o]}$.when.apply(this,n).done(t.resolve);return t.promise()}}};if(typeof Object.create!=="function"){Object.create=function(e){function t(){}t.prototype=e;return new t}}$.plugin=function(e,t){$.fn[e]=function(n){return this.each(function(){if(!$.data(this,e)){$.data(this,e,Object.create(t).init(n,this))}})}};$.plugin("blurbGallery",blurbGallery)